---
type JarvisEntry = {
  id: string;
  entryNumber: number;
  title: string;
  date: Date;
  formattedDate: string;
  bodyHtml: string;
};

const rawEntries = import.meta.glob('../content/jarvis/*.md', {
  eager: true,
  query: '?raw',
  import: 'default'
}) as Record<string, string>;

function escapeHtml(input: string): string {
  return input
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

function renderInlineMarkdown(input: string): string {
  let output = escapeHtml(input);
  output = output.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
  output = output.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  output = output.replace(/\*([^*]+)\*/g, '<em>$1</em>');
  return output;
}

function renderMarkdownToHtml(markdown: string): string {
  const paragraphs = markdown
    .trim()
    .split(/\n\s*\n/)
    .map((paragraph) => {
      const inline = paragraph
        .trim()
        .split('\n')
        .map((line) => renderInlineMarkdown(line.trim()))
        .join('<br />');
      return `<p>${inline}</p>`;
    });
  return paragraphs.join('');
}

function parseFrontmatter(rawContent: string): { meta: Record<string, string>; body: string } {
  const content = rawContent.replace(/^\uFEFF/, '').trim();
  const match = content.match(/^---\s*\r?\n([\s\S]*?)\r?\n---\s*\r?\n?([\s\S]*)$/);
  if (!match) {
    return { meta: {}, body: content };
  }

  const frontmatter = match[1] ?? '';
  const body = (match[2] ?? '').trim();
  const meta: Record<string, string> = {};

  for (const line of frontmatter.split('\n')) {
    const separatorIndex = line.indexOf(':');
    if (separatorIndex === -1) continue;
    const key = line.slice(0, separatorIndex).trim();
    const value = line.slice(separatorIndex + 1).trim().replace(/^['"]|['"]$/g, '');
    meta[key] = value;
  }

  return { meta, body };
}

function extractEntryNumber(path: string): number {
  const fileName = path.split('/').pop() ?? '';
  const match = fileName.match(/^(\d+)/);
  return match ? Number.parseInt(match[1], 10) : 0;
}

const entries: JarvisEntry[] = Object.entries(rawEntries)
  .map(([path, raw]) => {
    const parsed = parseFrontmatter(raw);
    const dateValue = parsed.meta.date ?? '1970-01-01';
    const date = new Date(`${dateValue}T00:00:00Z`);
    const entryNumber = extractEntryNumber(path);

    return {
      id: path,
      entryNumber,
      title: parsed.meta.title ?? `Entry ${entryNumber}`,
      date,
      formattedDate: date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        timeZone: 'UTC'
      }),
      bodyHtml: renderMarkdownToHtml(parsed.body)
    };
  })
  .sort((a, b) => b.date.getTime() - a.date.getTime() || b.entryNumber - a.entryNumber);
---

<section id="jarvis">
  <div class="jarvis-list">
    {entries.map((entry, index) => (
      <>
        <article class="jarvis-terminal reveal" style={`--reveal-delay: ${0.05 + index * 0.05}s;`}>
          <div class="jarvis-terminal-header">
            <div class="jarvis-terminal-dot r"></div>
            <div class="jarvis-terminal-dot y"></div>
            <div class="jarvis-terminal-dot g"></div>
            <span>jarvis â€” log --entry {entry.entryNumber}</span>
          </div>

          <div class="jarvis-terminal-body">
            <h3>{entry.title}</h3>
            <p class="jarvis-date">{entry.formattedDate}</p>
            <div class="jarvis-body" set:html={entry.bodyHtml}></div>
          </div>
        </article>
        {index < entries.length - 1 && <hr class="jarvis-entry-divider reveal" style={`--reveal-delay: ${0.08 + index * 0.05}s;`} />}
      </>
    ))}
  </div>

  <div class="jarvis-cursor-line reveal" style={`--reveal-delay: ${0.05 + entries.length * 0.05}s;`}>
    <span class="jarvis-prompt">$</span>
    <span class="jarvis-cursor" aria-hidden="true"></span>
  </div>
</section>

<style>
  #jarvis {
    min-height: auto;
  }

  .jarvis-list {
    display: flex;
    flex-direction: column;
    gap: 0.9rem;
  }

  .jarvis-entry-divider {
    border: none;
    border-top: 1px solid var(--border);
    margin: 0.1rem 0;
  }

  .jarvis-terminal {
    background: rgba(255, 255, 255, 0.025);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }

  .jarvis-terminal-header {
    display: flex;
    align-items: center;
    gap: 0.45rem;
    padding: 0.55rem 0.85rem;
    border-bottom: 1px solid var(--border);
    background: rgba(255, 255, 255, 0.03);
    color: var(--dim);
    font-size: 0.8rem;
    letter-spacing: 0.01em;
    font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
  }

  .jarvis-terminal-dot {
    width: 9px;
    height: 9px;
    border-radius: 999px;
  }

  .jarvis-terminal-dot.r { background: #ff5f57; }
  .jarvis-terminal-dot.y { background: #febc2e; }
  .jarvis-terminal-dot.g { background: #28c840; }

  .jarvis-terminal-body {
    padding: 1rem 1.1rem 1.15rem;
  }

  .jarvis-terminal-body h3 {
    margin: 0;
    font-weight: 600;
    color: var(--text);
    font-size: 1.05rem;
  }

  .jarvis-date {
    margin-top: 0.3rem;
    color: var(--dim);
    font-size: 0.8rem;
    font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
  }

  .jarvis-body {
    color: var(--dim);
    line-height: 1.7;
    font-size: 0.95rem;
    margin-top: 0.75rem;
  }

  .jarvis-body :global(p) {
    margin: 0;
  }

  .jarvis-body :global(p + p) {
    margin-top: 0.9rem;
    padding-top: 0.9rem;
    border-top: 1px solid var(--border);
  }

  .jarvis-body :global(a) {
    color: var(--text);
    text-decoration-color: rgba(255, 255, 255, 0.25);
    text-underline-offset: 2px;
  }

  .jarvis-cursor-line {
    margin-top: 0.95rem;
    display: flex;
    align-items: center;
    gap: 0.35rem;
    font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
    color: var(--dim);
    font-size: 0.9rem;
  }

  .jarvis-prompt {
    color: var(--accent);
  }

  .jarvis-cursor {
    width: 8px;
    height: 1.1em;
    background: #28c840;
    border-radius: 2px;
    animation: cursorBlink 1.1s step-end infinite;
    opacity: 0.85;
  }

</style>
