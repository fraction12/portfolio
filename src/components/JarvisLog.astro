---
type JarvisEntry = {
  id: string;
  entryNumber: number;
  title: string;
  date: Date;
  formattedDate: string;
  bodyHtml: string;
};

const rawEntries = import.meta.glob('../content/jarvis/*.md', {
  eager: true,
  query: '?raw',
  import: 'default'
}) as Record<string, string>;

function escapeHtml(input: string): string {
  return input
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

function renderInlineMarkdown(input: string): string {
  let output = escapeHtml(input);
  output = output.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
  output = output.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  output = output.replace(/\*([^*]+)\*/g, '<em>$1</em>');
  return output;
}

function renderMarkdownToHtml(markdown: string): string {
  const paragraphs = markdown
    .trim()
    .split(/\n\s*\n/)
    .map((paragraph) => {
      const inline = paragraph
        .trim()
        .split('\n')
        .map((line) => renderInlineMarkdown(line.trim()))
        .join('<br />');
      return `<p>${inline}</p>`;
    });
  return paragraphs.join('');
}

function parseFrontmatter(rawContent: string): { meta: Record<string, string>; body: string } {
  const content = rawContent.replace(/^\uFEFF/, '').trim();
  const match = content.match(/^---\s*\r?\n([\s\S]*?)\r?\n---\s*\r?\n?([\s\S]*)$/);
  if (!match) {
    return { meta: {}, body: content };
  }

  const frontmatter = match[1] ?? '';
  const body = (match[2] ?? '').trim();
  const meta: Record<string, string> = {};

  for (const line of frontmatter.split('\n')) {
    const separatorIndex = line.indexOf(':');
    if (separatorIndex === -1) continue;
    const key = line.slice(0, separatorIndex).trim();
    const value = line.slice(separatorIndex + 1).trim().replace(/^['"]|['"]$/g, '');
    meta[key] = value;
  }

  return { meta, body };
}

function extractEntryNumber(path: string): number {
  const fileName = path.split('/').pop() ?? '';
  const match = fileName.match(/^(\d+)/);
  return match ? Number.parseInt(match[1], 10) : 0;
}

const entries: JarvisEntry[] = Object.entries(rawEntries)
  .map(([path, raw]) => {
    const parsed = parseFrontmatter(raw);
    const dateValue = parsed.meta.date ?? '1970-01-01';
    const date = new Date(`${dateValue}T00:00:00Z`);
    const entryNumber = extractEntryNumber(path);

    return {
      id: path,
      entryNumber,
      title: parsed.meta.title ?? `Entry ${entryNumber}`,
      date,
      formattedDate: date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        timeZone: 'UTC'
      }),
      bodyHtml: renderMarkdownToHtml(parsed.body)
    };
  })
  .sort((a, b) => b.date.getTime() - a.date.getTime() || b.entryNumber - a.entryNumber);

const lastUpdated = entries.length > 0
  ? entries[0].date.toLocaleDateString('en-US', { month: 'short', year: 'numeric', timeZone: 'UTC' }).toLowerCase()
  : '';
---

<section id="jarvis">
  <div class="now-terminal reveal" style="--reveal-delay: 0.05s;">
    <div class="now-terminal-header">
      <div class="now-terminal-dot r"></div>
      <div class="now-terminal-dot y"></div>
      <div class="now-terminal-dot g"></div>
      <span>jarvis — log --recent</span>
    </div>

    <div class="now-terminal-body">
      <div class="now-line">
        <span class="now-prompt">$</span>
        <span class="now-cmd">jarvis</span>
        <span class="now-flag">log --recent</span>
      </div>
      <div class="now-line spacer"></div>

      {entries.map((entry, index) => (
        <>
          {index > 0 && <hr class="now-divider" />}
          <div class="now-line">
            <span class="now-dot-green" aria-hidden="true">●</span>
            <span class="now-val" style="font-weight:600;">{entry.title}</span>
          </div>
          <div class="now-line">
            <span class="now-flag">&nbsp;&nbsp;date:</span>
            <span class="now-val">{entry.formattedDate}</span>
          </div>
          <div class="jarvis-body-line">
            <div class="jarvis-body" set:html={entry.bodyHtml}></div>
          </div>
        </>
      ))}

      <div class="now-line spacer"></div>
      <div class="now-line">
        <span class="now-comment"># {entries.length} {entries.length === 1 ? 'entry' : 'entries'} · last updated {lastUpdated}</span>
      </div>
      <div class="now-line">
        <span class="now-prompt">$</span>
        <span class="now-cursor"></span>
      </div>
    </div>
  </div>
</section>

<style>
  #jarvis {
    min-height: auto;
  }

  .now-dot-green {
    color: #28c840;
    font-size: 0.7em;
    margin-right: 0.4rem;
    flex-shrink: 0;
  }

  .now-comment {
    color: var(--dim);
    font-size: 0.85rem;
    opacity: 0.6;
    font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
  }

  .jarvis-body-line {
    padding-left: 1.4rem;
    margin-top: 0.4rem;
    margin-bottom: 0.4rem;
  }

  .jarvis-body {
    color: var(--dim);
    line-height: 1.7;
    font-size: 0.95rem;
    font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
  }

  .jarvis-body :global(p) {
    margin: 0;
  }

  .jarvis-body :global(p + p) {
    margin-top: 0.9rem;
    padding-top: 0.9rem;
    border-top: 1px solid var(--border);
  }

  .jarvis-body :global(a) {
    color: var(--text);
    text-decoration-color: rgba(255, 255, 255, 0.25);
    text-underline-offset: 2px;
  }
</style>
